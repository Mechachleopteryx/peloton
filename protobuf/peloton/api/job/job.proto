/**
 *  This file defines the Job related messages in Peloton API
 */


syntax = "proto3";

package peloton.api.job;

option go_package = "peloton/api/job";
option java_package = "peloton.api.job";

import "peloton/api/peloton.proto";
import "peloton/api/errors/errors.proto";
import "peloton/api/task/task.proto";
import "peloton/api/query/query.proto";
import "peloton/api/respool/respool.proto";

/**
 *  Job type definition such as batch, service and infra agent.
 */
enum JobType {
  // Normal batch job which will run to completion after all instances finishes.
  BATCH = 0;

  // Service job which is long running and will be restarted upon failures.
  SERVICE = 1;

  // Daemon job which has one instance running on each host for infra
  // agents like muttley, m3collector etc.
  DAEMON = 2;
}


/**
 *  SLA configuration for a job
 */
message SlaConfig {

  //
  // Priority of a job. Higher value takes priority over lower value
  // when making scheduling decisions as well as preemption decisions
  //
  uint32 priority = 1;

  //
  // Whether the job instances are preemptible. If so, it might
  // be scheduled using revocable offers
  //
  bool preemptible = 2;

  //
  // Whether the job instances are revocable. If so, it might
  // be scheduled using revocable resources and subject to preemption
  // when other jobs reclaims those resources.
  //
  bool revocable = 3;

  //
  // Maximum number of instances to admit and run at any point in time.
  // If specified, should be <= instanceCount and >= minimumRunningInstances;
  // default value is instanceCount.
  //
  uint32 maximumRunningInstances = 4;

  //
  // Minimum number of instances to admit and run at any point in time.
  // If specified, should be <= maximumRunningInstances <= instanceCount;
  // default value is 1.  Admission requires the corresponding resource pool
  // has enough reserved resources for the full set of minimum number of instances.
  //
  uint32 minimumRunningInstances = 5;

  //
  // maxRunningTime represents the max time which all tasks of this job
  // can run. This timer starts when the task enters into running state.
  // if the tasks of this job exceeds this run time then they will be killed
  uint32 maxRunningTime = 6;
}


/**
 *  Job configuration
 */
message JobConfig {

  // Change log entry of the job config
  peloton.ChangeLog changeLog = 1;

  // Name of the job
  string name = 2;

  // Type of the job
  JobType type = 3;

  // Owning team of the job
  string owningTeam = 4;

  // LDAP groups of the job
  repeated string ldapGroups = 5;

  // Description of the job
  string description = 6;

  // List of user-defined labels for the job
  repeated peloton.Label labels = 7;

  // Number of instances of the job
  uint32 instanceCount = 8;

  // SLA config of the job
  SlaConfig sla = 9;

  // Default task configuration of the job
  task.TaskConfig defaultConfig = 10;

  // Instance specific task config which overwrites the default one
  map<uint32, task.TaskConfig> instanceConfig = 11;

  // Resource Pool ID where this job belongs to
  peloton.ResourcePoolID respoolID = 12;
}


/**
 *  Runtime states of a Job
 */
enum JobState {
  // Reserved for future compatibility of new states.
  UNKNOWN = 0;

  // The job has been initialized and persisted in DB.
  INITIALIZED = 1;

  // All tasks in the job are created and enqueued to resource manager
  PENDING = 2;

  // Any of the tasks in the job is in RUNNING state.
  RUNNING = 3;

  // All tasks in the job are in SUCCEEDED state.
  SUCCEEDED = 4;

  // All tasks in the job are in terminated state and one or more
  // tasks is in FAILED state.
  FAILED = 5;

  // All tasks in the job are in terminated state and one or more
  // tasks in the job is killed by the user.
  KILLED = 6;

  // All tasks in the job have been requested to be killed by the user.
  KILLING = 7;
}


/**
 *  Job RuntimeInfo provides the current runtime status of a Job
 */
message RuntimeInfo
{
  // State of the job
  JobState state = 1;

  // The time when the job was created. The time is represented in
  // RFC3339 form with UTC timezone.
  string creationTime = 2;

  // The time when the first task of the job starts to run. The time
  // is represented in RFC3339 form with UTC timezone.
  string startTime = 3;

  // The time when the last task of the job is completed. The time is
  // represented in RFC3339 form with UTC timezone.
  string completionTime = 4;

  // The number of tasks grouped by each task state. The map key is
  // the task.TaskState in string format and the map value is the number
  // of tasks in the particular state.
  map<string, uint32> taskStats = 5;

  // The version reflects the version of the JobConfig, that's currently
  // used by the job.
  int64 configVersion = 6;

  // Goal state of the job.
  JobState goalState = 7;
}

/**
 *  Information of a job, such as job config and runtime
 */
message JobInfo
{
  // Job ID
  peloton.JobID id = 1;

  // Job configuration
  JobConfig config = 2;

  // Job runtime information
  RuntimeInfo runtime = 3;
}

/**
 *  Summary of a job configuration and runtime.
 *  Will be returned as part of Job Query API response.
 */
message JobSummary
{
  // Job ID
  peloton.JobID id = 1;

  // Name of the job
  string name = 2;

  // Type of the job
  JobType type = 3;

  // Owner of the job
  string owner = 4;

  // Owning team of the job
  string owningTeam = 5;

  // List of user-defined labels for the job
  repeated peloton.Label labels = 6;

  // Number of instances of the job
  uint32 instanceCount = 7;

  // Resource Pool ID where this job belongs to
  peloton.ResourcePoolID respoolID = 8;

  // Job runtime information
  RuntimeInfo runtime = 9;
}

/**
 *  QuerySpec specifies the list of query criteria for jobs. All
 *  indexed fields should be part of this message. And all fields
 *  in this message have to be indexed too.
 */
message QuerySpec {
  // DEPRECATED: use QueryJobRequest.pagination instead.
  // The spec of how to do pagination for the query results.
  query.PaginationSpec pagination = 1;

  // List of labels to query the jobs. Will match all jobs if the
  // list is empty.
  repeated peloton.Label labels = 2;

  // List of keywords to query the jobs. Will match all jobs if
  // the list is empty. When set, will do a wildcard match on
  // owner, name, labels, description.
  repeated string keywords = 3;

  // List of job states to query the jobs. Will match all jobs if
  // the list is empty.
  repeated JobState jobStates = 4;

  // The resource pool to query the jobs. Will match jobs from all
  // resource pools if unset.
  respool.ResourcePoolPath respool = 5;

  // Query jobs by owner. This is case sensitive and will
  // look for jobs with owner matching the exact owner string.
  // Will match all jobs if owner is unset.
  string owner = 6;

  // Query jobs by name. This is case sensitive and will
  // look for jobs with name matching the name string. Will
  // support partial name match. Will match all jobs if
  // name is unset.
  string name = 7;
}

/**
 *  DEPRECATED by peloton.api.job.svc.JobService
 *  Job Manager service interface
 */
service JobManager {

  // Create a Job entity for a given config
  rpc Create(CreateRequest) returns (CreateResponse);

  // Get the config of a job entity
  rpc Get(GetRequest) returns (GetResponse);

  // Query the jobs that match a list of labels.
  rpc Query(QueryRequest) returns (QueryResponse);

  // Delete a job entity and stop all related tasks
  rpc Delete(DeleteRequest) returns (DeleteResponse);

  // Update a Job entity with a new config
  rpc Update(UpdateRequest) returns (UpdateResponse);

  // Debug only method. Allows user to load job runtime state from DB
  // and re-execute the action associated with current state.
  rpc Refresh(RefreshRequest) returns (RefreshResponse);
}

// DEPRECATED by google.rpc.ALREADY_EXISTS error
message JobAlreadyExists {
  peloton.JobID id = 1;
  string message = 2;
}

// DEPRECATED by google.rpc.NOT_FOUND error
message JobNotFound {
  peloton.JobID id = 1;
  string message = 2;
}

// DEPRECATED by google.rpc.INVALID_ARGUMENT error
message InvalidJobId {
  peloton.JobID id = 1;
  string message = 2;
}

// DEPRECATED by google.rpc.INVALID_ARGUMENT error
message InvalidJobConfig {
  peloton.JobID id = 1;
  string message = 2;
}

// DEPRECATED by peloton.api.job.svc.CreateJobRequest
message CreateRequest {
  peloton.JobID id = 1;
  JobConfig config = 2;
}

// DEPRECATED by peloton.api.job.svc.CreateJobResponse
message CreateResponse {
  message Error {
    JobAlreadyExists alreadyExists = 1;
    InvalidJobConfig invalidConfig = 2;
    InvalidJobId     invalidJobId = 3;
  }

  Error error = 1;
  peloton.JobID jobId = 2;
}

// DEPRECATED by peloton.api.job.svc.UpdateJobRequest
message UpdateRequest {
  peloton.JobID id = 1;
  JobConfig config = 2;
}

// DEPRECATED by peloton.api.job.svc.UpdateJobResponse
message UpdateResponse {
  message Error {
    JobNotFound jobNotFound = 1;
    InvalidJobConfig invalidConfig = 2;
    InvalidJobId invalidJobId = 3;
  }
  Error error = 1;
  peloton.JobID id = 2;
  string message = 3;
}

// DEPRECATED by peloton.api.job.svc.GetJobRequest
message GetRequest {
  peloton.JobID id = 1;
}

// DEPRECATED by peloton.api.job.svc.GetJobResponse
message GetResponse {
  message Error {
    errors.JobNotFound notFound = 1;
    errors.JobGetRuntimeFail getRuntimeFail = 2;
  }

  Error error = 1;

  JobInfo jobInfo = 2;
}

// DEPRECATED by peloton.api.job.svc.QueryJobsRequest
message QueryRequest {
  peloton.ResourcePoolID respoolID = 1;

  // Per instance configuration in the job configuration cannot be  queried.
  QuerySpec spec = 2;
}

// DEPRECATED by peloton.api.job.svc.QueryJobsResponse
message QueryResponse {
   message Error {
    errors.UnknownError err = 1;
    errors.InvalidRespool invalidRespool = 2;
  }
  Error error = 1;

  // DEPRECATED by peloton.api.job.JobSummary
  // JobInfo is huge and there is no need to return it in QueryResponse.
  // NOTE: instanceConfig is not returned as part of jobConfig inside jobInfo
  // as it can be so huge that exceeds grpc limit size. Use Job.Get() API to get
  // instanceConfig for job.
  repeated JobInfo records = 2;

  query.Pagination pagination = 3;

  // The query spec from the request
  QuerySpec spec = 4;

  // Job summary
  repeated JobSummary results = 5;
}

// DEPRECATED by peloton.api.job.svc.DeleteRequest
message DeleteRequest {
  peloton.JobID id = 1;
}

// DEPRECATED by peloton.api.job.svc.DeleteResponse
message DeleteResponse {
  message Error {
    errors.JobNotFound notFound = 1;
  }

  Error error = 1;
}

// DEPRECATED by peloton.api.job.svc.RefreshJobRequest
message RefreshRequest {
  peloton.JobID id = 1;
}

// DEPRECATED by peloton.api.job.svc.RefreshJobResponse
message RefreshResponse {}
