

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Peloton Dev &mdash; Home 1.0.0 documentation</title>
  

  
  
  

  
  <link rel="top" title="Home 1.0.0 documentation" href="index.html"/>
  <link rel="prev" title="Training" href="training.html"/>


  
  

<!-- Adds favicon -->
  <link rel="shortcut icon" type="image/png" href="_static/favicon.png"/>
  <link rel="stylesheet" href="_static/main.css"/>
  <link rel="stylesheet" href="https://d1a3f4spazzrp4.cloudfront.net/uber-icons/3.14.0/uber-icons.css">
  <link rel="stylesheet" href="https://d1a3f4spazzrp4.cloudfront.net/uber-fonts/4.0.0/superfine.css">
  <link rel="stylesheet" href="_APIs/code-highlighter.css"/>
</head>

<body class=" no-index ">
<div class="db-wrapper">
  <div class="db-inner">
    
    <nav class="db-navigation layout__item">
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="overview.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#architecture">Architecture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="head_get_started.html">Get Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="head_get_started.html#atg-users">ATG Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="head_get_started.html#prime-users">PRIME Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="head_get_started.html#wbu-users">WBU Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="head_get_started.html#peloton-clients">Peloton Clients</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="userguide.html">User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="userguide.html#api-doc">Api Doc</a></li>
<li class="toctree-l2"><a class="reference internal" href="userguide.html#resource-pools">Resource Pools</a></li>
<li class="toctree-l2"><a class="reference internal" href="userguide.html#preemption">Preemption</a></li>
<li class="toctree-l2"><a class="reference internal" href="userguide.html#peloton-resources">Peloton Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="troubleshoot.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="troubleshoot.html#access-to-peloton-job">Access to Peloton Job</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshoot.html#peloton-cluster">Peloton Cluster</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="training.html">Training</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Peloton Dev</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#install">Install</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-peloton-apps-in-containers">Run Peloton apps in containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-peloton">Test Peloton</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-unit-tests">Run unit tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-integration-tests">Run integration tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build">Build</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run">Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="#master-with-pcluster">Master with pcluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="#client">Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="#packaging">Packaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tagging-a-new-release">Tagging a new release</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pushing-docker-containers">Pushing docker containers</a></li>
</ul>
</li>
</ul>

    </nav>
    
    <header class="db-header">
      <svg class="db-header__bg">
        <defs>
        <!--Use this to reduce the header image size on the landing page.-->
          <pattern id="background-pattern" width="20" height="20" patternUnits="userSpaceOnUse">
            <path class="db-header__bg__stroke"
                  d="M15 40H0m45 0H15m30-20H15m30 20h15M15 20H0m45 0h15M10 60h10M40 0h10M10 0L0 30l15 10 25 20L20 0l25 20 15 10-10 30"></path>
            <path class="db-header__bg__stroke" d="M60 52l-10 8H40M20 0H10L0 8m0 0l15 12 30 20 15 12"></path>
            <path class="db-header__bg__stroke"
                  d="M0 52l15-12 30-20L60 8 50 0l10 30-15 10-25 20L40 0 15 20 0 30l10 30z"></path>
          </pattern>
        </defs>
        <rect fill="url(#background-pattern)" height="100%" width="100%"></rect>
      </svg>

      <div class="db-header__logo layout push--sides">
        <div class="layout__item">
          <a class="db-header__logo__title kilo primary-font" href="index.html">

<!-- Editable content -->
Peloton 

          </a>
          <div class="db-header__logo__description epsilon primary-font">

<!-- Editable content -->
            Unified Scheduler for all compute 

          </div>
        </div>
      </div>
      <!--Takes the user back to the EngDocs landing page-->
      <a class="db-header__go_back" href="https://engdocs.uberinternal.com/">Go back</a>

      <form class="db-header__search" id="rtd-search-form" action="search.html" method="get">
        <div class="db-header__search__wrap">

  <!-- Editable content -->
          <input class="db-header__search__input" type="text" name="q" placeholder="Search EngDocs"/>
          <i class="db-header__search__icon icon icon_search"></i>
        </div>
        <input type="hidden" name="check_keywords" value="yes"/>
        <input type="hidden" name="area" value="default"/>
      </form>

      <a class="db-header__bit" href="faq.html">

<!-- Editable content -->
       Get answers to questions about Product

        <span class="db-header__bit__more">
          Read FAQ <i class="db-header__bit__arrow icon icon_right-arrow-thin push-tiny--left"></i>
        </span>
      </a>

    </header>

    
  

<!-- Creates mini TOCs on each page  --> 
      <div class="layout layout--rev push--sides">
      <div class="layout__item one-quarter desk-one-third palm-one-whole db-side-menu push--bottom">
        <br/><br/><br/>
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="head_get_started.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="userguide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshoot.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="training.html">Training</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Peloton Dev</a><ul class="simple">
</ul>
</li>
</ul>

        <hr class="style14"/>
        <ul>
<li><a class="reference internal" href="#">Peloton Dev</a><ul>
<li><a class="reference internal" href="#install">Install</a></li>
<li><a class="reference internal" href="#run-peloton-apps-in-containers">Run Peloton apps in containers</a></li>
<li><a class="reference internal" href="#test-peloton">Test Peloton</a></li>
<li><a class="reference internal" href="#run-unit-tests">Run unit tests</a></li>
<li><a class="reference internal" href="#run-integration-tests">Run integration tests</a><ul>
<li><a class="reference internal" href="#run-peloton-from-docker-container">Run peloton from docker container</a></li>
</ul>
</li>
<li><a class="reference internal" href="#build">Build</a></li>
<li><a class="reference internal" href="#run">Run</a></li>
<li><a class="reference internal" href="#master-with-pcluster">Master with pcluster</a></li>
<li><a class="reference internal" href="#client">Client</a></li>
<li><a class="reference internal" href="#packaging">Packaging</a></li>
<li><a class="reference internal" href="#tagging-a-new-release">Tagging a new release</a></li>
<li><a class="reference internal" href="#pushing-docker-containers">Pushing docker containers</a><ul>
<li><a class="reference internal" href="#debug-peloton-apps-in-docker-container">Debug Peloton Apps in Docker Container</a></li>
<li><a class="reference internal" href="#pressure-test-the-cassandra-store">Pressure test the cassandra store</a></li>
</ul>
</li>
</ul>
</li>
</ul>

      </div>
      <div class="layout__item three-quarters desk-two-thirds palm-one-whole db-content">



        <div class="section" id="peloton-dev">
<span id="id1"></span><h1>Peloton Dev<a class="headerlink" href="#peloton-dev" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference external" href="http://t.uber.com/peloton">Project Page</a></li>
<li><a class="reference external" href="https://code.uberinternal.com/w/runbooks/peloton/">Runbook</a></li>
</ul>
<div class="section" id="install">
<h2>Install<a class="headerlink" href="#install" title="Permalink to this headline">¶</a></h2>
<p>Installations of protoc/proto/protoc-gen-go are required, run bootstrap.sh once so all build dependencies will be installed.  Want to build debian package or docker image ? Follow packaging/README.md</p>
<p>$ cd $GOPATH</p>
<p>$ mkdir -p src/github.com/uber/</p>
<p>$ git clone <a class="reference external" href="mailto:gitolite&#37;&#52;&#48;code&#46;uber&#46;internal">gitolite<span>&#64;</span>code<span>&#46;</span>uber<span>&#46;</span>internal</a>:infra/peloton src/github.com/uber/peloton</p>
<p>$ cd $GOPATH/src/github.com/uber/peloton</p>
<p>$ ./bootstrap.sh</p>
<p>$ glide install</p>
<p>$ make devtools</p>
<p>$ make</p>
</div>
<div class="section" id="run-peloton-apps-in-containers">
<h2>Run Peloton apps in containers<a class="headerlink" href="#run-peloton-apps-in-containers" title="Permalink to this headline">¶</a></h2>
<p>Build docker image:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ IMAGE=uber/peloton make docker
</pre></div>
</div>
<p>Launch all dependencies and peloton apps in containers:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ PELOTON=app make pcluster
</pre></div>
</div>
</div>
<div class="section" id="test-peloton">
<h2>Test Peloton<a class="headerlink" href="#test-peloton" title="Permalink to this headline">¶</a></h2>
<p>Create resource pool by providing the path(respool is required for job creation):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ bin/peloton respool create /DefaultResPool example/default_respool.yaml
Resource Pool d214ed86-1cf5-4e39-a0bb-08399ab1dee0 created at /DefaultResPool
</pre></div>
</div>
<p>Create job:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ bin/peloton job create /DefaultResPool example/testjob.yaml
Job 91b1b8e5-2ba8-11e7-bc23-0242ac11000d created
</pre></div>
</div>
<p>Get tasks:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ bin/peloton task list &lt;job ID&gt;
</pre></div>
</div>
</div>
<div class="section" id="run-unit-tests">
<h2>Run unit tests<a class="headerlink" href="#run-unit-tests" title="Permalink to this headline">¶</a></h2>
<p>Run unit tests:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ make test
</pre></div>
</div>
</div>
<div class="section" id="run-integration-tests">
<h2>Run integration tests<a class="headerlink" href="#run-integration-tests" title="Permalink to this headline">¶</a></h2>
<p>Against local pcluster:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ make integ-test
</pre></div>
</div>
<p>Against a real cluster:
irn1 (ATG VPN connection required):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ CLUSTER=&lt;name of the cluster, i.e. peloton-devel01&gt; make integ-test
</pre></div>
</div>
<p>dca1/sjc1 (run this from any compute host in the target dc):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ CLUSTER=&lt;name of the cluster, i.e. dca1-devel01&gt; make integ-test
</pre></div>
</div>
<div class="section" id="run-peloton-from-docker-container">
<h3>Run peloton from docker container<a class="headerlink" href="#run-peloton-from-docker-container" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="build">
<h2>Build<a class="headerlink" href="#build" title="Permalink to this headline">¶</a></h2>
<p>Build:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ make docker
...
Built uber/peloton:51f1c4f
</pre></div>
</div>
<p>If you want to build an image with a different name: <cite>IMAGE=foo/bar:baz make docker</cite></p>
</div>
<div class="section" id="run">
<h2>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h2>
<p>The docker container takes a few environment variables to configure how it will run. Each peloton
app is launchable by setting <cite>APP=$name</cite> in the environment. For example, to run the
peloton-master, execute:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ docker run --rm --name peloton -it -p 5289:5289 -e APP=master -e ENVIRONMENT=development peloton
</pre></div>
</div>
<p>Configurations are stored in <cite>/etc/peloton/$APP/</cite>, and by default we will pass the following
arguments: <cite>-c &#8220;/etc/peloton/${APP}/base.yaml&#8221; -c &#8220;/etc/peloton/${APP}/${ENVIRONMENT}.yaml&#8221;</cite></p>
<p>NOTE: you need to make sure the container has access to all the dependencies it needs, like mesos-master,
zookeeper, cassandra, etc. Check your configs!</p>
</div>
<div class="section" id="master-with-pcluster">
<h2>Master with pcluster<a class="headerlink" href="#master-with-pcluster" title="Permalink to this headline">¶</a></h2>
<p>Master with pcluster:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ make pcluster
$ docker run --rm --name peloton -it -e APP=master -e ENVIRONMENT=development --link peloton-mesos-master:mesos-master --link peloton-zk:zookeeper --link peloton-cassandra:cassandra peloton
</pre></div>
</div>
</div>
<div class="section" id="client">
<h2>Client<a class="headerlink" href="#client" title="Permalink to this headline">¶</a></h2>
<p>Launching the client is similar (replace <cite>-m</cite> argument with whereever your peloton-master runs:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ docker run --rm -it --link peloton:peloton -e APP=client peloton job -m http://peloton:5289/ create test1 test/testjob.yaml
</pre></div>
</div>
</div>
<div class="section" id="packaging">
<h2>Packaging<a class="headerlink" href="#packaging" title="Permalink to this headline">¶</a></h2>
<p>Build debs for supported distributions. Output will be placed into <cite>./debs</cite>. You can specify
the DISTRIBUTION by passing <cite>DISTRIBUTION=jessie</cite> (jessie and trusty are supported). Defaults
to <cite>all</cite>.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ make debs
</pre></div>
</div>
</div>
<div class="section" id="tagging-a-new-release">
<h2>Tagging a new release<a class="headerlink" href="#tagging-a-new-release" title="Permalink to this headline">¶</a></h2>
<p>Releases are managed by git tags, using semantic versioning. To tag a new release:</p>
<p>Check the current version:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ make version
0.1.0-abcdef
</pre></div>
</div>
<p>Make sure you are on master, and have the proper sha at HEAD you want to tag. Then,
increment the version and tag, then push tags:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ git tag -a 0.2.0
...
$ git push origin --tags
</pre></div>
</div>
</div>
<div class="section" id="pushing-docker-containers">
<h2>Pushing docker containers<a class="headerlink" href="#pushing-docker-containers" title="Permalink to this headline">¶</a></h2>
<p><cite>make docker-push</cite> will build docker containers, and push them to both ATG and
SJC1 registries. You can push to only one DC with <cite>DC=atg</cite> or <cite>DC=sjc1</cite>. You can
override the image to push with <cite>IMAGE=foo/bar:baz</cite></p>
<p>To build and deploy docker containers everywhere:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>make docker docker-push
</pre></div>
</div>
<div class="section" id="debug-peloton-apps-in-docker-container">
<h3>Debug Peloton Apps in Docker Container<a class="headerlink" href="#debug-peloton-apps-in-docker-container" title="Permalink to this headline">¶</a></h3>
<p>1. Find docker container process ID:
sudo docker inspect -f {{.State.Pid}} &lt;DOCKER_IMAGE_ID&gt;</p>
<p>2. Run a bash shell in the container:
nsenter -t &lt;PID&gt; -m -p bash</p>
<p>3. Setup source code directory symlink:
mkdir -p /workspace/src/github.com/uber/
ln -s /peloton-install /workspace/src/$(make project-name)</p>
<p>4. Start the gdb in the bash shell:
gdb peloton-install/bin/peloton-[hostmgr|jobmgr|resmgr|placement] &lt;PID&gt;</p>
<ol class="arabic simple" start="5">
<li>Happy debugging ;-)</li>
</ol>
</div>
<div class="section" id="pressure-test-the-cassandra-store">
<h3>Pressure test the cassandra store<a class="headerlink" href="#pressure-test-the-cassandra-store" title="Permalink to this headline">¶</a></h3>
<p>We have a tool for pressure testing the cassandra store, which is based on the storage.TaskStore interface.</p>
<p>1. Build the cassandra store tool:
make db-pressure</p>
<ol class="arabic simple" start="2">
<li>Run test against a cassandra store. For example</li>
</ol>
<p>bin/dbpressure -s peloton_pressure -t 1000 -w 200 -h ms-3162c292.pit-irn-1.uberatc.net -c ONE</p>
<p>Also need to make sure to have the schema migration files under storage/cassandra/migrations</p>
<p>After running the load into C*, one can check the C* dashboard, for example
<a class="reference external" href="https://graphite.uberinternal.com/grafana2/dashboard/db/cassandra-mesos-irn">https://graphite.uberinternal.com/grafana2/dashboard/db/cassandra-mesos-irn</a></p>
</div>
</div>
</div>

        
        <div class="layout layout--middle layout--flush">
          <div class="layout__item one-half">
      </div>
    </div>



  


  </div>
</div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
  <script type="text/javascript" src="_static/js/theme.js"></script>
   


<!-- Urate code -->
<script type="text/javascript">
  (function() {
    var sct = document.createElement('script');
    sct.src = 'https://s3-us-west-2.amazonaws.com/uber-common-private/svc-urate/widget/0.0.65.min.js'
    sct.type = 'text/javascript';
    sct.onload = function() {
      // this will run after it's loaded
      UrateWidget({
        app: 'Documentation',
        position: 'bottom-left',
        csrfPath: null,
        initialMessage: 'How satisfied are you with the peloton documentation?',
        theme: 'stars-dark',
        displayBugsButton: false,
        minimal: false,
        path: '/backend/_urate',
        tags: ['Platform: EngDocs', 'Topic: peloton'],
        zIndex: 1100,
        ratings: [
          {
            value: 1,
            display: 'Bad',
            smiley: 'bad',
            question: 'What made you dissatisfied?'
          },
          {
            value: 2,
            display: 'Poor',
            smiley: 'poor',
            question: 'What made you dissatisfied?'
          },
          {
            value: 3,
            display: 'Regular',
            smiley: 'regular',
            question: 'What made you not satisfied?'
          },
          {
            value: 4,
            display: 'Good',
            smiley: 'good',
            question: 'What could be improved?'
          },
          {
            value: 5,
            display: 'Great',
            smiley: 'great',
            question: 'What do you like?'
          }
        ],
      });
    }
    document.body.appendChild(sct);
  })();
</script>
<!-- End Urate code -->

<!-- banner.js -->
<script type="text/javascript" src="/index-static/banner.js"></script>
<!-- end banner.js -->


</html>

